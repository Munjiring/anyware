<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd" >
<mapper namespace="chatMapper">

	<resultMap type="ChatRoom" id="roomResult">
		<id column="chatroom_no" property="chatroomNo" />
		<result column="chat_title" property="chatTitle" />
		<result column="chat_type" property="chatType" />
		<result column="create_date" property="createDate" />
		<result column="not_read" property="notRead" />
		<result column="chat_content" property="chatContent" />
		<result column="send_date" property="sendDate" />
	</resultMap>
	
	<resultMap type="Thumbnail" id="thumbnailResult">
		<id column="chatcontent_no" property="contentNo" />
		<result column="chatroom_no" property="roomNo" />
		<result column="chat_content" property="content" />
		<result column="send_date" property="sendDate" />
		<result column="send_time" property="sendTime" />
		<result column="origin_name" property="originName" />
		<result column="change_name" property="changeName" />
		<result column="not_read" property="notRead" />
		<result column="profile_url" property="profileUrl" />
		<result column="dept_name" property="deptName" />
		<result column="job_name" property="jobName" />
		<result column="writer_No" property="writerNo" />
		<result column="writer_Name" property="writerName" />
	</resultMap>
	
	<resultMap type="ChatContent" id="contentResult">
		<result column="send_date" property="sendDate" />
		<collection property="chatInfo" ofType="Thumbnail" >
			<id column="chatcontent_no" property="contentNo" />
			<result column="chatroom_no" property="roomNo" />
			<result column="writer_No" property="writerNo" />
			<result column="writer_Name" property="writerName" />
			<result column="chat_content" property="content" />
			<result column="send_time" property="sendTime" />
			<result column="origin_name" property="originName" />
			<result column="change_name" property="changeName" />
			<result column="not_read" property="notRead" />
			<result column="profile_url" property="profileUrl" />
			<result column="dept_name" property="deptName" />
			<result column="job_name" property="jobName" />
		</collection>
	</resultMap>
	
	<select id="selectChatRoomList" resultMap="thumbnailResult">
		SELECT DISTINCT
		       CHATROOM_NO
             , CHATCONTENT_NO
		     , CHAT_CONTENT
		     , TO_CHAR(SEND_DATE, 'YYYY"년" MM"월" DD"일"') "SEND_DATE"
		     , TO_CHAR(SEND_DATE, 'HH24:MM') "SEND_TIME"
		     , WRITER_NO
		     , NAME "WRITER_NAME"
		     , DEPT_NAME
		     , JOB_NAME
		     , PROFILE_URL
		     , NOT_READ
		  FROM TB_CHATCONTENT
		  JOIN TB_MEMBER ON (WRITER_NO = MEMBER_NO)
          JOIN TB_CHATMEMBER USING (CHATROOM_NO)
		 WHERE (CHATROOM_NO, SEND_DATE) IN (SELECT CHATROOM_NO, MAX(SEND_DATE)
		                                      FROM TB_CHATCONTENT
		                                     GROUP 
		                                        BY CHATROOM_NO)
		 ORDER
		    BY CHATCONTENT_NO DESC
	</select>
	
	<update id="updateCount">
		update
			   tb_chatmember
		   set not_read = 0
		 where chatroom_no = #{roomNo}
		   and member_no = ${myNo}
	</update>
	
	<select id="selectChatContentList" resultMap="contentResult">
		select
		       chatcontent_no
		     , writer_no
		     , name "writer_name"
		     , dept_name
		     , job_name
		     , profile_url
		     , chat_content
		     , origin_name
		     , change_name
		     , TO_CHAR(SEND_DATE, 'YYYY"년" MM"월" DD"일"') "SEND_DATE"
		     , TO_CHAR(SEND_DATE, 'HH24:MM') "SEND_TIME"
		  from tb_chatcontent
		  join tb_member on (member_no = writer_no)
		 where chatroom_no = #{roomNo}
		 order
		    by chatcontent_no
	</select>
	
	<insert id="insertChat">
		<selectKey keyProperty="contentNo"  resultType="_int" order="AFTER">
			SELECT SEQ_CHCNO.CURRVAL "CONTENT_NO" FROM DUAL
		</selectKey>
		insert
		  into tb_chatcontent
		  (
		  	chatcontent_no
		  , chatroom_no
		  , writer_no
		  , chat_content
		  )
		  values
		  (
		  	seq_chcno.nextval
		  , #{roomNo}
		  , #{writerNo}
		  , #{content}
		  )
	</insert>
	
	<select id="selectChatContent" resultMap="thumbnailResult">
		select
		       name "writer_name"
		     , writer_no
		     , dept_name
		     , job_name
		     , profile_url
		     , chat_content
		     , TO_CHAR(SEND_DATE, 'YYYY"년" MM"월" DD"일"') "SEND_DATE"
		     , TO_CHAR(SEND_DATE, 'HH24:MM') "SEND_TIME"
		  from tb_chatcontent
		  join tb_member on (writer_no = member_no)
		 where chatcontent_no = #{contentNo}
	</select>
  
</mapper>
